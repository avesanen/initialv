<!doctype html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <title>index</title>
    <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<h2>InitialV</h2>
<div style="position: relative; border-style: solid; border-width: 1px; width: 640px; height: 480px;">
    <canvas id="layer1" width="640" height="480"
            style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
    <canvas id="layer2" width="640" height="480"
            style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
</div>
Use [left/right] arrows to turn the ship and [up] arrow to engage the thruster.

<script>
    // Quick and dirty map drawing with test map image.
    var map = function() {
        var canvas = document.getElementById('layer1');
        var context = canvas.getContext('2d');
        this.imageObj = new Image();
        this.x = 0;
        this.y = 0;
        // Initial dimensions - should be large enough for player's starting
        // location to not clip in case image loading lags.
        this.width = 7680;
        this.height = 7200;
        
        // Draw and move the map
        // s = ship to "follow"
        this.refresh = function(s) {
			this.x = -s.x+canvas.width/2;
			this.y = -s.y+canvas.height/2;
			if (this.x < -this.imageObj.width+canvas.width) this.x = -this.imageObj.width+canvas.width;
			if (this.y < -this.imageObj.height+canvas.height) this.y = -this.imageObj.height+canvas.height;
			if (this.x > 0) this.x = 0;
			if (this.y > 0) this.y = 0;
            context.drawImage(this.imageObj, this.x, this.y);
        };
        
        
        // Get dimensions of the image after it is loaded
        this.imageObj.onload = function() {
        	//TODO: doesn't work :(
        	//this.width = this.imageObj.width;
        	//this.height = this.imageObj.height;
        }
        
        // Set map image to load
        this.imageObj.src = "img/test.png";
    };

	// Player's ship
	var ship = function () {
		this.angle = 2;
		this.x = 100;
		this.y = 100;
		this.dx = 0;
		this.dy = 0;
		
		// Draw and move the ship, handle key presses
		// m = map
		this.refresh = function(m) 
		{
			// Rotate
			if(keyStates[37]) {
              	this.angle-=0.07;
            }
            if(keyStates[39]) {
               	this.angle+=0.07;
            }
            // Thrust
            thrusting = false;
            if(keyStates[38]) {
            	this.dx += Math.sin(this.angle)*0.1;
            	this.dy -= Math.cos(this.angle)*0.1;
            	thrusting = true;
            }
            
            // Move the ship
            this.dy = this.dy + 0.00981; // gravitation
            this.y += this.dy;
            this.x += this.dx;
            // Map edge clipping
            if (this.x < 0) {this.x = 0;this.dx=0;}
            if (this.y < 0) {this.y = 0;this.dy=0;}
            if (this.x > m.width) {this.x = m.width;this.dx=0;}
            if (this.y > m.height) {this.y = m.height;this.dy=0;}
            // Map pixel collision
            //TODO: how to implement - imageObj has no way to read individual pixels?
            
            var canvas = document.getElementById('layer1');
    		var ctx = canvas.getContext('2d');
    		ctx.save(); // we want to rotate only the ship
    		ctx.translate(this.x+m.x,this.y+m.y); // ship's center will be 0,0 for drawing
			// Draw the ship body
    		ctx.beginPath();
    		ctx.strokeStyle = '#00ff00';
    		ctx.lineWidth = 2;
    		ctx.rotate(this.angle);
    		ctx.moveTo(0,-8);
    		ctx.lineTo(-8,+8);
    		ctx.lineTo(+8,+8);
    		ctx.closePath();
    		ctx.stroke();
    		// Draw the fire too, if thruster is engaged
    		if (thrusting)
    		{
    			ctx.beginPath();
    			ctx.strokeStyle = '#ff7f00';
    			ctx.lineWidth = 2;
    			ctx.moveTo(-6, +8);
    			ctx.lineTo(0, +16);
    			ctx.lineTo(+6, +8);
    			ctx.closePath();
    		}
    		ctx.stroke();
    		ctx.restore(); // restore rotation etc.
		};
	};
	
	// Keyboard states
    var keyStates = {};
    var keyBuffer = [];
    function onKeyboard(e) {
        if(e.type == "keydown") {
            if(!keyStates[e.keyCode]) {
                keyStates[e.keyCode] = true;
                keyBuffer.push(e.keyCode);
            }
        }
        if(e.type == "keyup") {
            if(keyStates[e.keyCode]){
                keyStates[e.keyCode] = false;
            }
        }
    }

    $(window).bind('keydown',function(e){
        onKeyboard(e);
    });

    $(window).bind('keyup',function(e){
        onKeyboard(e);
    });

    
    // Refresh one by one, always in correct drawing order
    // Map and ship need each others coordinates for drawing and edge boundaries
    var m = new map();
    var s = new ship();
    setInterval(function(){m.refresh(s);s.refresh(m);}, 1000/60); // 60Hz

    

</script>

<script>
    var socket = io.connect('http://localhost');
    socket.on('newobject', function (data) {
    });
</script>

</body>

</html>
